{% extends "base.html" %}
{% load static %}

{% block title %}
Welcome to Greenova
{% endblock %}

{% block meta_description %}
Greenova helps environmental professionals monitor compliance status and manage regulatory obligations efficiently.
{% endblock %}

{% block meta %}
{{ block.super }}
  <meta name="keywords"
        content="environmental management, compliance tracking, regulatory obligations, sustainability" />

  <!-- Resource hints -->
  <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
  <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />

  <!-- HTMX configuration for post-logout handling -->
  {% if is_post_logout %}
    <meta name="htmx-config"
          content='{"refreshOnHistoryMiss": true, "swapStyle": "transition:true"}' />
  {% endif %}
{% endblock %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/dist/pages/landing.css' %}" />
  <link rel="stylesheet"
        href="{% static 'css/dist/components/animations.css' %}" />
{% endblock %}

{% block extra_head %}
  <!-- GSAP CDN with fallback -->
  <script>
  // Set a timeout for GSAP loading
  const GSAP_TIMEOUT = 3000;
  window.gsapLoaded = new Promise((resolve, reject) => {
    const timeoutId = setTimeout(() => {
      reject(new Error('GSAP loading timeout'));
    }, GSAP_TIMEOUT);

    window.addEventListener('gsap-loaded', () => {
      clearTimeout(timeoutId);
      resolve();
    });
  });
  </script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/gsap.min.js"
          onload="window.dispatchEvent(new Event('gsap-loaded'))"
          onerror="console.warn('GSAP failed to load, falling back to basic animations')"></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollTrigger.min.js"
          defer></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/ScrollSmoother.min.js"
          defer></script>
  <script src="https://cdn.jsdelivr.net/npm/gsap@3.13.0/dist/Flip.min.js" defer></script>
{% endblock %}

{% block content %}
  <!-- Post-logout handler with smooth transition -->
  {% if is_post_logout %}
    <div id="reload-trigger"
         hx-trigger="load delay:100ms"
         hx-get="{% url 'landing:home' %}"
         hx-target="body"
         hx-swap="innerHTML transition:true">
    </div>
  {% endif %}

  <!-- Main content with progressive enhancement -->
  <div class="hero-logo-container fade-in" data-no-gsap-fallback>
    <img src="{% static 'img/favicon.svg' %}"
         alt="Greenova Logo"
         class="hero-logo"
         width="80"
         height="80"
         loading="eager" />
    <span class="hero-brand-title">Greenova</span>
  </div>

  <main id="main-content"
        hx-boost="true"
        hx-push-url="true"
        hx-target="main"
        hx-swap="innerHTML transition:true">

    <!-- Content sections -->
{% include "landing/sections/_hero.html" %}
{% include "landing/sections/_features.html" %}
{% include "landing/sections/_stats.html" %}
{% include "landing/sections/_benefits.html" %}
{% include "landing/sections/_testimonials.html" %}
{% include "landing/sections/_cta.html" %}
  </main>

  <!-- Initialize landing page module with fallback -->
  <script type="module">
  import init from "{% static 'ts/dist/landing.bundle.js' %}";
  
  try {
    // Wait for GSAP to load or timeout
    await window.gsapLoaded;
    init();
  } catch (error) {
    console.warn('Falling back to basic animations:', error);
    // Add basic CSS animations class when GSAP fails
    document.body.classList.add('basic-animations');
  }
  </script>

  <!-- Fallback styles for when GSAP fails -->
  <style>
  .basic-animations [data-no-gsap-fallback] {
    animation: fadeIn 0.5s ease-out;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(20px); }
    to { opacity: 1; transform: translateY(0); }
  }
  </style>
{% endblock %}

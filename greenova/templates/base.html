<!--
  Copyright 2025 Enveng Group.
  SPDX-License-Identifier: 	AGPL-3.0-or-later
  Base HTML template for Greenova Environmental Management System

  This template provides the core structure for all pages in the application.

  Features:
  - Responsive design using PicoCSS
  - Dark/Light theme support
  - HTMX for dynamic content loading
  - Hyperscript for client-side interactivity
  - WCAG 2.1 AA compliance
-->
{% extends "base_minimal.html" %}
{% load static %}
{% load hyperscript %}
{% load django_htmx %}
{% load tailwind_tags %}
{% load user_tags %}
{% load core_tags %}

{% block meta %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <meta name="color-scheme" content="light dark" />
  <meta name="keywords"
        content="environmental compliance, management system, greenova, sustainability" />
  <meta name="description"
        content="
                 {% block meta_description %}
                   Environmental Compliance Management System
                 {% endblock meta_description %}" />
  <meta name="htmx-config"
        content='{ "useTemplateFragments": true, "historyCacheSize": 10, "refreshOnHistoryMiss": true, "defaultSettleDelay": 20, "timeout": 10000, "wsReconnectDelay": 2000 }' />
{% endblock %}

{% block title %}
  {% block page_title %}
      greenova
  {% endblock page_title %}
{% endblock title %}

{% block head_scripts %}
  <!-- Core dependencies -->
  <script src="{% static 'ts/dist/helper.bundle.js' %}" type="module"></script>
  <script src="{% static 'ts/dist/wasm-loader.bundle.js' %}" type="module"></script>
  <script src="{% static 'ts/dist/theme-manager.bundle.js' %}" type="module"></script>
  <script src="{% static 'ts/dist/error-handler.bundle.js' %}" type="module"></script>
  <script src="{% static 'ts/dist/foldable.bundle.js' %}" type="module"></script>
  <script src="{% static 'ts/dist/app-modules.bundle.js' %}" type="module"></script>

  <!-- HTMX -->
  <script src="{% static 'js/vendor/htmx/htmx.min.js' %}" defer></script>
{% django_htmx_script %}

  <!-- HTMX Extensions -->
  <script src="{% static 'js/vendor/htmx/ext/head-support.min.js' %}" defer></script>
  <script src="{% static 'js/vendor/htmx/ext/loading-states.min.js' %}" defer></script>
  <script src="{% static 'js/vendor/htmx/ext/class-tools.min.js' %}" defer></script>
  <script src="{% static 'js/vendor/htmx/ext/path-deps.min.js' %}" defer></script>
{% endblock %}

{% block extra_css %}
{% endblock extra_css %}

{% block extra_head %}
  {{ block.super }}
{% endblock extra_head %}

{% block body_attrs %}
  hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'
  hx-ext="head-support, loading-states, class-tools, path-deps"
  hx-boost="true"
  hx-swap="innerHTML transition:true"
  hx-indicator="#htmx-indicator"
  data-theme="{{ request.session.theme|default:'light' }}"
{% endblock %}

{% block body %}
  <!-- Skip to main content link for accessibility -->
  <a class="skip-link" href="#main-content">Skip to content</a>

  <!-- Header -->
  <header role="banner">
{% include "layouts/_header.html" %}
  </header>

  <!-- Main content -->
  <main id="main-content" role="main" hx-history-elt>
    {% block content %}
    {% endblock %}
  </main>

  <!-- Footer -->
  <footer role="contentinfo">
{% include "layouts/_footer.html" %}
  </footer>

  <!-- Loading indicator -->
  <div id="htmx-indicator" class="htmx-indicator" aria-hidden="true">
    <div class="spinner">
    </div>
  </div>

  {% block modal %}
  {% endblock %}
{% endblock %}

{% block body_end %}
  <!-- Initialize theme -->
  <script type="module">
    import { initializeWasmModule } from "{% static 'ts/dist/wasm-loader.bundle.js' %}";
    import { ThemeManager } from "{% static 'ts/dist/theme-manager.bundle.js' %}";

    async function initTheme() {
      try {
        const wasmModule = await initializeWasmModule();
        const themeManager = new ThemeManager(wasmModule);
        themeManager.init();

        // Listen for HTMX events
        document.body.addEventListener('htmx:afterSettle', () => {
          themeManager.applyTheme(themeManager.getCurrentTheme());
        });
      } catch (error) {
        console.warn('Theme initialization failed:', error);
      }
    }

    // Initialize as soon as modules are loaded
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initTheme);
    } else {
      initTheme();
    }
  </script>
{% endblock %}

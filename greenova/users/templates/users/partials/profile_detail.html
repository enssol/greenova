<section class="profile-details">
  <div class="profile-header">
    <div class="profile-image-container">
      {% if profile.profile_image %}
        <img src="{{ profile.profile_image.url }}" alt="Profile image for {{ profile.user.username }}" class="profile-image" />
      {% else %}
        <div class="profile-image placeholder">
          {{ profile.user.username|slice:":1"|upper }}
        </div>
      {% endif %}

      <div class="image-upload"
           _="on dragover halt the event
              add .dragover to me
              on dragleave remove .dragover from me
              on drop halt the event
              remove .dragover from me
              call upload(event.dataTransfer.files[0])">
        <form id="imageUploadForm" enctype="multipart/form-data">
          {% csrf_token %}
          <input type="file" name="profile_image" id="profile_image" accept="image/*"
                 _="on change call upload(this.files[0])" />
          <label for="profile_image">Change photo</label>
        </form>
      </div>
    </div>

    <div class="profile-name">
      <h2>{{ profile.user.get_full_name|default:profile.user.username }}</h2>
      <p>{{ profile.position }}</p>
      <p>{{ profile.department }}</p>
    </div>
  </div>

  <div class="profile-body">
    <dl>
      <dt>Username</dt>
      <dd>{{ profile.user.username }}</dd>

      <dt>Email</dt>
      <dd>{{ profile.user.email }}</dd>

      {% if profile.phone_number %}
        <dt>Phone</dt>
        <dd>{{ profile.phone_number }}</dd>
      {% endif %}

      {% if profile.bio %}
        <dt>Bio</dt>
        <dd>{{ profile.bio }}</dd>
      {% endif %}

      <dt>Account Since</dt>
      <dd>{{ profile.user.date_joined|date:"F j, Y" }}</dd>
    </dl>
  </div>

  <div class="profile-actions">
    <button class="btn-primary"
            hx-get="{% url 'users:profile_edit' %}"
            hx-target=".profile-container"
            hx-push-url="true">
      Edit Profile
    </button>

    <button class="btn-secondary"
            hx-get="{% url 'users:change_password' %}"
            hx-target=".profile-container"
            hx-push-url="true">
      Change Password
    </button>
  </div>
</section>

<script>
  function upload(file) {
    if (!file) return;

    const formData = new FormData();
    formData.append('profile_image', file);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    fetch('{% url "users:upload_profile_image" %}', {
      method: 'POST',
      body: formData,
      credentials: 'same-origin'
    })
    .then(response => response.json())
    .then(data => {
      if (data.status === 'success') {
        const imageEl = document.querySelector('.profile-image');
        if (imageEl && imageEl.tagName === 'IMG') {
          imageEl.src = data.image_url + '?timestamp=' + new Date().getTime();
        } else {
          const container = document.querySelector('.profile-image-container');
          container.innerHTML = `<img src="${data.image_url}?timestamp=${new Date().getTime()}" alt="Profile image" class="profile-image">`;
        }
      } else {
        alert('Failed to upload image: ' + JSON.stringify(data.errors));
      }
    })
    .catch(error => {
      console.error('Error:', error);
      alert('An error occurred while uploading your image.');
    });
  }
</script>
